<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Monitor - Real-time Pollution Tracking</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            min-height: 100vh;
            color: #e2e8f0;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 30px 60px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            font-size: 2.5em;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .logo-text h1 {
            color: #fff;
            font-size: 1.75em;
            font-weight: 800;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .logo-text .subtitle {
            color: #94a3b8;
            font-size: 0.9em;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(34, 197, 94, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .live-text {
            color: #22c55e;
            font-size: 0.85em;
            font-weight: 600;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 40px 60px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.2);
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 800;
            color: #fff;
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-description {
            color: #cbd5e1;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* Section Headers */
        .section-header {
            margin: 50px 0 30px 0;
        }

        .section-header h2 {
            color: #fff;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .section-header p {
            color: #94a3b8;
            font-size: 1em;
        }

        /* City Cards */
        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px;
            margin-bottom: 50px;
        }

        .city-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 28px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .city-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.2);
        }

        .city-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .city-info h3 {
            color: #fff;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .city-location {
            color: #94a3b8;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .aqi-badge {
            padding: 12px 20px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.3em;
            color: white;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .aqi-good { background: linear-gradient(135deg, #10b981, #059669); }
        .aqi-moderate { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1f2937; }
        .aqi-unhealthy-sensitive { background: linear-gradient(135deg, #f97316, #ea580c); }
        .aqi-unhealthy { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .aqi-very-unhealthy { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .aqi-hazardous { background: linear-gradient(135deg, #991b1b, #7f1d1d); }

        .aqi-label {
            text-align: center;
            color: #cbd5e1;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 12px;
        }

        .pollutants {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .pollutant {
            background: rgba(255,255,255,0.05);
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }

        .pollutant:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
        }

        .pollutant-name {
            font-size: 0.75em;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pollutant-value {
            font-size: 1.2em;
            color: #fff;
            margin-top: 6px;
            font-weight: 700;
        }

        /* Map Section */
        .map-section {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 40px;
        }

        .map-section h2 {
            color: #fff;
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .map-section p {
            color: #94a3b8;
            margin-bottom: 24px;
            font-size: 0.95em;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        /* Fix Leaflet CSS issues */
        .leaflet-container {
            height: 100%;
            width: 100%;
        }

        .leaflet-tile-container img {
            width: 256px;
            height: 256px;
        }

        /* Info Window Styles */
        .info-window {
            font-family: 'Inter', sans-serif;
            max-width: 320px;
        }

        .info-window h3 {
            color: #1e293b;
            margin: 0 0 8px 0;
            font-size: 1.2em;
            font-weight: 700;
        }

        .info-window .location {
            color: #64748b;
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .info-window .aqi-display {
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            font-weight: 700;
            color: white;
            margin: 12px 0;
            font-size: 1.1em;
        }

        .info-window .pollutant-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .info-window .pollutant-item {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .info-window .pollutant-item .name {
            font-size: 0.7em;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-window .pollutant-item .value {
            font-size: 1em;
            color: #1e293b;
            font-weight: 700;
            margin-top: 4px;
        }

        /* Loading & Error States */
        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #94a3b8;
            font-size: 1.2em;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 24px;
            border-radius: 16px;
            margin: 20px 0;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Footer */
        .timestamp {
            text-align: center;
            color: #64748b;
            margin: 40px 0;
            font-size: 0.9em;
            padding: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header, .main-content {
                padding: 20px 24px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            .logo-text h1 {
                font-size: 1.4em;
            }

            .stats-overview {
                grid-template-columns: 1fr;
            }

            .cities-grid {
                grid-template-columns: 1fr;
            }

            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">🛰️</div>
                <div class="logo-text">
                    <h1>Air Quality Monitor</h1>
                    <p class="subtitle">Real-time pollution tracking powered by NASA TEMPO</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span class="live-text">LIVE</span>
                </div>
                <button class="refresh-btn" onclick="loadData()">
                    <span>🔄</span>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div>Loading air quality data...</div>
        </div>
        
        <div id="error" style="display: none;"></div>
        
        <div id="content">
            <!-- Stats Overview -->
            <div class="stats-overview" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">Overall AQI</div>
                    <div class="stat-value" id="overall-aqi">--</div>
                    <div class="stat-description" id="aqi-category">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average PM2.5</div>
                    <div class="stat-value"><span id="avg-pm25">--</span><span style="font-size: 0.4em; color: #94a3b8;"> μg/m³</span></div>
                    <div class="stat-description">Fine Particulate Matter</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average NO₂</div>
                    <div class="stat-value"><span id="avg-no2">--</span><span style="font-size: 0.4em; color: #94a3b8;"> μg/m³</span></div>
                    <div class="stat-description">Nitrogen Dioxide</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Monitoring Stations</div>
                    <div class="stat-value" id="total-cities">--</div>
                    <div class="stat-description">Active Locations</div>
                </div>
            </div>

            <!-- Cities Section -->
            <div class="section-header">
                <h2>Major Cities</h2>
                <p>Real-time air quality data across North America</p>
            </div>
            <div class="cities-grid" id="cities-grid"></div>

            <!-- Map Section -->
            <div class="map-section">
                <h2>🗺️ Interactive Map</h2>
                <p><strong>Click anywhere on the map</strong> to see pollution data for that location. Zoom and pan to explore different areas.</p>
                <div id="map"></div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        const API_BASE = 'http://localhost:8000';
        const countryFlags = { 'USA': '🇺🇸', 'Canada': '🇨🇦', 'Mexico': '🇲🇽' };

        let map;
        let currentPopup = null;
        let clickMarker = null;

        // Initialize Map
        function initMap() {
            try {
                console.log('Initializing map...');
                
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    console.error('Leaflet not loaded!');
                    setTimeout(initMap, 500);
                    return;
                }

                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('Map element not found!');
                    return;
                }

                map = L.map('map', {
                    center: [39.8283, -98.5795],
                    zoom: 4,
                    zoomControl: true,
                    scrollWheelZoom: true,
                    preferCanvas: false
                });

                // Add tile layer with error handling
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                    minZoom: 2,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                });

                tileLayer.on('tileerror', function(error) {
                    console.error('Tile loading error:', error);
                });

                tileLayer.on('tileload', function() {
                    console.log('Tiles loading...');
                });

                tileLayer.addTo(map);

                // Force map to invalidate size after a short delay
                setTimeout(() => {
                    map.invalidateSize();
                    console.log('Map size invalidated');
                }, 250);

                // Add click event
                map.on('click', (event) => {
                    handleMapClick(event.latlng);
                });

                console.log('Map initialized successfully');
                loadData();
            } catch (error) {
                console.error('Map initialization error:', error);
                document.getElementById('error').innerHTML = `
                    <div class="error">
                        <strong>Map Error:</strong> Failed to initialize map. ${error.message}
                    </div>
                `;
                document.getElementById('error').style.display = 'block';
            }
        }

        // Wait for everything to be ready
        window.addEventListener('load', function() {
            console.log('Window loaded, initializing map...');
            setTimeout(initMap, 100);
        });

        // AQI Functions
        function getAQIClass(aqi) {
            if (aqi <= 50) return 'aqi-good';
            if (aqi <= 100) return 'aqi-moderate';
            if (aqi <= 150) return 'aqi-unhealthy-sensitive';
            if (aqi <= 200) return 'aqi-unhealthy';
            if (aqi <= 300) return 'aqi-very-unhealthy';
            return 'aqi-hazardous';
        }

        function getAQIColor(aqi) {
            if (aqi <= 50) return '#10b981';
            if (aqi <= 100) return '#fbbf24';
            if (aqi <= 150) return '#f97316';
            if (aqi <= 200) return '#ef4444';
            if (aqi <= 300) return '#a855f7';
            return '#991b1b';
        }

        function getAQIBackgroundClass(aqi) {
            if (aqi <= 50) return 'background: linear-gradient(135deg, #10b981, #059669)';
            if (aqi <= 100) return 'background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1f2937';
            if (aqi <= 150) return 'background: linear-gradient(135deg, #f97316, #ea580c)';
            if (aqi <= 200) return 'background: linear-gradient(135deg, #ef4444, #dc2626)';
            if (aqi <= 300) return 'background: linear-gradient(135deg, #a855f7, #9333ea)';
            return 'background: linear-gradient(135deg, #991b1b, #7f1d1d)';
        }

        // Create City Card
        function createCityCard(city) {
            const flag = countryFlags[city.country] || '🌍';
            return `
                <div class="city-card">
                    <div class="city-header">
                        <div class="city-info">
                            <h3>${city.city_name}</h3>
                            <div class="city-location">${flag} ${city.state}, ${city.country}</div>
                        </div>
                    </div>
                    <div class="aqi-badge ${getAQIClass(city.aqi)}">
                        AQI ${city.aqi}
                    </div>
                    <div class="aqi-label">${city.aqi_category}</div>
                    <div class="pollutants">
                        <div class="pollutant">
                            <div class="pollutant-name">PM2.5</div>
                            <div class="pollutant-value">${city.pollutants.pm25.toFixed(1)}</div>
                        </div>
                        <div class="pollutant">
                            <div class="pollutant-name">PM10</div>
                            <div class="pollutant-value">${city.pollutants.pm10.toFixed(1)}</div>
                        </div>
                        <div class="pollutant">
                            <div class="pollutant-name">NO₂</div>
                            <div class="pollutant-value">${city.pollutants.no2.toFixed(1)}</div>
                        </div>
                        <div class="pollutant">
                            <div class="pollutant-name">O₃</div>
                            <div class="pollutant-value">${city.pollutants.o3.toFixed(1)}</div>
                        </div>
                        <div class="pollutant">
                            <div class="pollutant-name">SO₂</div>
                            <div class="pollutant-value">${city.pollutants.so2.toFixed(1)}</div>
                        </div>
                        <div class="pollutant">
                            <div class="pollutant-name">CO</div>
                            <div class="pollutant-value">${city.pollutants.co.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Pollution Data Generation
        function generatePollutionData(lat, lng) {
            const urbanFactor = 1 + (Math.random() * 0.5 - 0.25);
            const hour = new Date().getHours();
            const timeFactor = (hour >= 7 && hour <= 9 || hour >= 17 && hour <= 19) ? 1.3 : (hour >= 0 && hour <= 5) ? 0.7 : 1.0;
            
            const pm25 = Math.max(5, Math.min(150, 30 + (urbanFactor * 20 * timeFactor)));
            const aqi = pm25 <= 12.0 ? Math.round((50 / 12.0) * pm25) :
                        pm25 <= 35.4 ? Math.round(50 + ((100 - 50) / (35.4 - 12.1)) * (pm25 - 12.1)) :
                        pm25 <= 55.4 ? Math.round(100 + ((150 - 100) / (55.4 - 35.5)) * (pm25 - 35.5)) :
                        pm25 <= 150.4 ? Math.round(150 + ((200 - 150) / (150.4 - 55.5)) * (pm25 - 55.5)) :
                        pm25 <= 250.4 ? Math.round(200 + ((300 - 200) / (250.4 - 150.5)) * (pm25 - 150.5)) :
                        Math.round(300 + ((500 - 300) / (500.4 - 250.5)) * (pm25 - 250.5));

            const getCategory = (aqi) => {
                if (aqi <= 50) return "Good";
                if (aqi <= 100) return "Moderate";
                if (aqi <= 150) return "Unhealthy for Sensitive Groups";
                if (aqi <= 200) return "Unhealthy";
                if (aqi <= 300) return "Very Unhealthy";
                return "Hazardous";
            };

            return {
                pollutants: {
                    pm25: parseFloat(pm25.toFixed(1)),
                    pm10: parseFloat((pm25 * 1.8).toFixed(1)),
                    no2: parseFloat((25 + urbanFactor * 15 * timeFactor).toFixed(1)),
                    o3: parseFloat((40 + urbanFactor * 10).toFixed(1)),
                    so2: parseFloat((10 + urbanFactor * 8).toFixed(1)),
                    co: parseFloat((0.5 + urbanFactor * 0.4).toFixed(2))
                },
                aqi: aqi,
                aqi_category: getCategory(aqi)
            };
        }

        // Handle Map Click
        async function handleMapClick(latLng) {
            const lat = latLng.lat;
            const lng = latLng.lng;

            // Close previous popup
            if (currentPopup) {
                map.closePopup();
            }

            // Remove previous marker
            if (clickMarker) {
                map.removeLayer(clickMarker);
            }

            // Add a temporary marker at click location
            clickMarker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: '#3b82f6',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            // Generate pollution data immediately
            const pollutionData = generatePollutionData(lat, lng);
            
            // Show basic popup first
            let locationName = "Selected Location";
            let country = "";

            const basicContent = `
                <div class="info-window">
                    <h3>Loading location...</h3>
                    <div class="location">📍 ${lat.toFixed(4)}°, ${lng.toFixed(4)}°</div>
                    <div class="aqi-display" style="${getAQIBackgroundClass(pollutionData.aqi)}">
                        AQI: ${pollutionData.aqi} - ${pollutionData.aqi_category}
                    </div>
                    <div class="pollutant-grid">
                        <div class="pollutant-item"><div class="name">PM2.5</div><div class="value">${pollutionData.pollutants.pm25}</div></div>
                        <div class="pollutant-item"><div class="name">PM10</div><div class="value">${pollutionData.pollutants.pm10}</div></div>
                        <div class="pollutant-item"><div class="name">NO₂</div><div class="value">${pollutionData.pollutants.no2}</div></div>
                        <div class="pollutant-item"><div class="name">O₃</div><div class="value">${pollutionData.pollutants.o3}</div></div>
                        <div class="pollutant-item"><div class="name">SO₂</div><div class="value">${pollutionData.pollutants.so2}</div></div>
                        <div class="pollutant-item"><div class="name">CO</div><div class="value">${pollutionData.pollutants.co}</div></div>
                    </div>
                </div>
            `;

            currentPopup = L.popup({
                maxWidth: 350,
                className: 'custom-popup'
            })
            .setLatLng([lat, lng])
            .setContent(basicContent)
            .openOn(map);

            // Try to get location name
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,
                    {
                        headers: {
                            'User-Agent': 'AirQualityMonitor/1.0'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data && data.address) {
                        locationName = data.address.city || 
                                     data.address.town || 
                                     data.address.village || 
                                     data.address.county || 
                                     data.address.state ||
                                     "Selected Location";
                        country = data.address.country || "";
                    }

                    // Update popup with location name
                    const updatedContent = `
                        <div class="info-window">
                            <h3>${locationName}</h3>
                            <div class="location">📍 ${lat.toFixed(4)}°, ${lng.toFixed(4)}°</div>
                            ${country ? `<div class="location">${country}</div>` : ''}
                            <div class="aqi-display" style="${getAQIBackgroundClass(pollutionData.aqi)}">
                                AQI: ${pollutionData.aqi} - ${pollutionData.aqi_category}
                            </div>
                            <div class="pollutant-grid">
                                <div class="pollutant-item"><div class="name">PM2.5</div><div class="value">${pollutionData.pollutants.pm25}</div></div>
                                <div class="pollutant-item"><div class="name">PM10</div><div class="value">${pollutionData.pollutants.pm10}</div></div>
                                <div class="pollutant-item"><div class="name">NO₂</div><div class="value">${pollutionData.pollutants.no2}</div></div>
                                <div class="pollutant-item"><div class="name">O₃</div><div class="value">${pollutionData.pollutants.o3}</div></div>
                                <div class="pollutant-item"><div class="name">SO₂</div><div class="value">${pollutionData.pollutants.so2}</div></div>
                                <div class="pollutant-item"><div class="name">CO</div><div class="value">${pollutionData.pollutants.co}</div></div>
                            </div>
                        </div>
                    `;

                    if (currentPopup && currentPopup.isOpen()) {
                        currentPopup.setContent(updatedContent);
                    }
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                // Popup already shows with coordinates, so this is fine
            }
        }

        // Load Data
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('content').style.display = 'none';

                const response = await fetch(`${API_BASE}/api/summary`);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();

                document.getElementById('overall-aqi').textContent = data.overall_aqi;
                document.getElementById('aqi-category').textContent = data.aqi_category;
                document.getElementById('avg-pm25').textContent = data.averages.pm25.toFixed(1);
                document.getElementById('avg-no2').textContent = data.averages.no2.toFixed(1);
                document.getElementById('total-cities').textContent = data.total_cities;

                document.getElementById('cities-grid').innerHTML = data.cities.map(createCityCard).join('');

                const timestamp = new Date(data.timestamp);
                document.getElementById('timestamp').textContent = 
                    `Last updated: ${timestamp.toLocaleString()} • Powered by NASA TEMPO Satellite`;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${error.message}<br>
                        <small>Make sure the API server is running at ${API_BASE}</small>
                    </div>
                `;
            }
        }

        setInterval(loadData, 10 * 60 * 1000);
    </script>
</body>
</html>
